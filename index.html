<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AC Circuit Calculator – General RLC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      max-width: 900px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .field {
      flex: 1 1 150px;
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    label {
      margin-bottom: 0.15rem;
    }
    input, select, button {
      padding: 0.35rem;
      font-size: 1rem;
    }
    button {
      cursor: pointer;
    }
    .outputs {
      margin-top: 1rem;
      border-top: 1px solid #ccc;
      padding-top: 0.75rem;
    }
    .out-box {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      border-radius: 4px;
      min-height: 1.4rem;
      background: #f9f9f9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.25rem 0.4rem;
      text-align: right;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    thead {
      background: #f3f3f3;
      position: sticky;
      top: 0;
    }
    .comp-row {
      border: 1px solid #eee;
      padding: 0.3rem;
      border-radius: 4px;
    }
    .small-btn {
      font-size: 0.8rem;
      padding: 0.25rem 0.4rem;
    }
  </style>
</head>
<body>

<h1>AC Circuit Calculator (General RLC)</h1>

<!-- BASIC SETTINGS -->
<div class="row">
  <div class="field">
    <label for="mode">Connection</label>
    <select id="mode">
      <option value="series">Series</option>
      <option value="parallel">Parallel</option>
    </select>
  </div>
  <div class="field">
    <label for="V">Source Voltage V (Vrms)</label>
    <input type="number" id="V" step="any">
  </div>
  <div class="field">
    <label for="f">Frequency f (Hz)</label>
    <input type="number" id="f" step="any">
  </div>
</div>

<!-- COMPONENT LIST -->
<h2 style="font-size:1.1rem;margin-top:0.75rem;">Components</h2>

<div id="components"></div>

<button id="addCompBtn">+ Add Component</button>

<div class="row">
  <button id="calcBtn">Calculate</button>
  <button id="clearBtn">Clear</button>
</div>

<!-- TOTAL OUTPUTS -->
<div class="outputs">
  <h2 style="font-size:1.1rem;">Totals (Equivalent Circuit)</h2>

  <div class="row">
    <div class="field">
      <label>|Z| (Ω)</label>
      <div class="out-box out" id="Ztot"></div>
    </div>
    <div class="field">
      <label>IT (A)</label>
      <div class="out-box out" id="IT"></div>
    </div>
    <div class="field">
      <label>PTRUE (W)</label>
      <div class="out-box out" id="Ptrue"></div>
    </div>
  </div>

  <div class="row">
    <div class="field">
      <label>PVARL total (VAR)</label>
      <div class="out-box out" id="PvarL"></div>
    </div>
    <div class="field">
      <label>PVARC total (VAR)</label>
      <div class="out-box out" id="PvarC"></div>
    </div>
    <div class="field">
      <label>PAPP LOAD (VA)</label>
      <div class="out-box out" id="PappLoad"></div>
    </div>
    <div class="field">
      <label>PAPP SOURCE (VA)</label>
      <div class="out-box out" id="PappSource"></div>
    </div>
  </div>

  <div class="row">
    <div class="field">
      <label>Equivalent XL (Ω)</label>
      <div class="out-box out" id="XL_eq"></div>
    </div>
    <div class="field">
      <label>Equivalent XC (Ω)</label>
      <div class="out-box out" id="XC_eq"></div>
    </div>
    <div class="field">
      <label>Power Factor</label>
      <div class="out-box out" id="PF"></div>
    </div>
    <div class="field">
      <label>θ (degrees)</label>
      <div class="out-box out" id="Theta"></div>
    </div>
  </div>
</div>

<!-- PER-ELEMENT RESULTS -->
<div class="outputs">
  <h2 style="font-size:1.1rem;">Per-Element Results</h2>
  <table>
    <thead>
      <tr>
        <th>Label</th>
        <th>Type</th>
        <th>Value (Ω/H/F)</th>
        <th>R or XL/XC (Ω)</th>
        <th>|Z| (Ω)</th>
        <th>I (A)</th>
        <th>V (V)</th>
        <th>P (W)</th>
        <th>Q (VAR)</th>
      </tr>
    </thead>
    <tbody id="perElementBody"></tbody>
  </table>
</div>

<script>
  // ---------- UI: add/remove components ----------
  const compContainer = document.getElementById('components');
  const addBtn = document.getElementById('addCompBtn');

  function addComponentRow(defaultType = 'R') {
    const row = document.createElement('div');
    row.className = 'row comp-row';

    row.innerHTML = `
      <div class="field">
        <label>Type</label>
        <select class="comp-type">
          <option value="R"${defaultType === 'R' ? ' selected' : ''}>R (Ω)</option>
          <option value="L"${defaultType === 'L' ? ' selected' : ''}>L (H)</option>
          <option value="C"${defaultType === 'C' ? ' selected' : ''}>C (F)</option>
        </select>
      </div>
      <div class="field">
        <label>Value</label>
        <input type="number" step="any" class="comp-value">
      </div>
      <div class="field">
        <label>Label (optional)</label>
        <input type="text" class="comp-label" placeholder="R1, L2, C3">
      </div>
      <div class="field" style="flex:0 0 auto;align-items:flex-start;">
        <label>&nbsp;</label>
        <button type="button" class="small-btn remove-comp">X</button>
      </div>
    `;

    row.querySelector('.remove-comp').addEventListener('click', () => {
      compContainer.removeChild(row);
    });

    compContainer.appendChild(row);
  }

  addBtn.addEventListener('click', () => addComponentRow());

  // Start with three rows for convenience
  addComponentRow('R');
  addComponentRow('L');
  addComponentRow('C');

  // ---------- Complex helpers ----------
  function c(re, im) { return { re, im }; }
  function cAdd(a, b) { return c(a.re + b.re, a.im + b.im); }
  function cSub(a, b) { return c(a.re - b.re, a.im - b.im); }
  function cMul(a, b) {
    return c(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re);
  }
  function cDiv(a, b) {
    const den = b.re*b.re + b.im*b.im;
    if (!den) return c(0, 0);
    return c((a.re*b.re + a.im*b.im)/den,
             (a.im*b.re - a.re*b.im)/den);
  }
  function cInv(a) {
    const den = a.re*a.re + a.im*a.im;
    if (!den) return c(0, 0);
    return c(a.re/den, -a.im/den);
  }
  function cMag(a) { return Math.hypot(a.re, a.im); }
  function cAngleDeg(a) {
    return Math.atan2(a.im, a.re) * 180 / Math.PI;
  }

  function clearOutputs() {
    document.querySelectorAll('.out').forEach(o => o.textContent = '');
    document.getElementById('perElementBody').innerHTML = '';
  }

  function show(id, val, digits = 3) {
    if (!isFinite(val)) val = 0;
    document.getElementById(id).textContent = val.toFixed(digits);
  }

  // ---------- Core calculation ----------
  function calculate() {
    clearOutputs();

    const Vval = parseFloat(document.getElementById('V').value) || 0;
    const f    = parseFloat(document.getElementById('f').value) || 0;
    const mode = document.getElementById('mode').value; // "series" or "parallel"
    const w    = 2 * Math.PI * f;

    // Get components
    const rows = document.querySelectorAll('.comp-row');
    const comps = [];
    rows.forEach((row, idx) => {
      const type  = row.querySelector('.comp-type').value;
      const value = parseFloat(row.querySelector('.comp-value').value);
      const label = row.querySelector('.comp-label').value.trim() || (type + (idx+1));

      if (!isFinite(value) || value <= 0) return;

      let Z;
      if (type === 'R') {
        Z = c(value, 0);
      } else if (type === 'L') {
        if (f <= 0) return;
        const XL = w * value;
        Z = c(0, XL);
      } else { // C
        if (f <= 0) return;
        const XC = 1 / (w * value);
        Z = c(0, -XC);
      }
      comps.push({ type, value, label, Z });
    });

    if (!comps.length || Vval <= 0 || f <= 0) {
      return;
    }

    const Vphasor = c(Vval, 0);

    // Total impedance and element currents/voltages
    let Ztot;
    if (mode === 'series') {
      Ztot = comps.reduce((acc, el) => cAdd(acc, el.Z), c(0, 0));
    } else {
      // parallel: sum admittances, then invert
      let Ytot = c(0, 0);
      comps.forEach(el => {
        Ytot = cAdd(Ytot, cInv(el.Z));
      });
      Ztot = cInv(Ytot);
    }

    const Zmag = cMag(Ztot);
    const I_total_ph = cDiv(Vphasor, Ztot);
    const IT = cMag(I_total_ph);

    // Per-element calculations
    let Ptotal = 0;
    let Q_L_total = 0;
    let Q_C_total = 0;

    const tbody = document.getElementById('perElementBody');

    comps.forEach(el => {
      let I_ph, V_ph;

      if (mode === 'series') {
        I_ph = I_total_ph;
        V_ph = cMul(I_total_ph, el.Z);
      } else {
        V_ph = Vphasor;
        I_ph = cDiv(Vphasor, el.Z);
      }

      const I_mag = cMag(I_ph);
      const V_mag = cMag(V_ph);
      const Rpart = el.Z.re;
      const Xpart = el.Z.im;
      const Zmag_el = cMag(el.Z);

      const P = I_mag * I_mag * Rpart;
      const Q = I_mag * I_mag * Xpart;

      Ptotal += P;
      if (Q > 0) Q_L_total += Q;
      if (Q < 0) Q_C_total += -Q;

      // For table: "reactance or R"
      let RXdisplay = 0;
      if (el.type === 'R') {
        RXdisplay = Rpart;
      } else if (el.type === 'L') {
        RXdisplay = Xpart; // XL
      } else {
        RXdisplay = -Xpart; // XC positive
      }

      const tr = document.createElement('tr');
      function td(text) {
        const cell = document.createElement('td');
        cell.textContent = text;
        return cell;
      }

      tr.appendChild(td(el.label));
      tr.appendChild(td(el.type));
      tr.appendChild(td(valueToStr(el.value)));
      tr.appendChild(td(numToStr(RXdisplay)));
      tr.appendChild(td(numToStr(Zmag_el)));
      tr.appendChild(td(numToStr(I_mag)));
      tr.appendChild(td(numToStr(V_mag)));
      tr.appendChild(td(numToStr(P)));
      tr.appendChild(td(numToStr(Q)));

      tbody.appendChild(tr);
    });

    const Qtotal = Q_L_total - Q_C_total;
    const S = Vval * IT;

    // Equivalent series reactance from total Q
    let XL_eq = 0, XC_eq = 0;
    if (IT > 0) {
      const Xeq = Qtotal / (IT * IT);
      if (Xeq > 0) XL_eq = Xeq;
      if (Xeq < 0) XC_eq = -Xeq;
    }

    const PF = (S > 0) ? (Ptotal / S) : 0;
    const thetaDeg = Math.atan2(Qtotal, Ptotal) * 180 / Math.PI;

    // Totals to screen
    show('Ztot', Zmag);
    show('IT', IT);
    show('Ptrue', Ptotal);
    show('PvarL', Q_L_total);
    show('PvarC', Q_C_total);
    show('PappLoad', S);
    show('PappSource', S);
    show('XL_eq', XL_eq);
    show('XC_eq', XC_eq);
    show('PF', PF, 4);
    show('Theta', thetaDeg, 2);
  }

  function numToStr(v, digits = 3) {
    if (!isFinite(v)) v = 0;
    return Number(v.toFixed(digits)).toString();
  }

  function valueToStr(v) {
    if (!isFinite(v)) return '';
    return v.toString();
  }

  function clearAll() {
    document.querySelectorAll('.comp-value').forEach(i => i.value = '');
    document.getElementById('V').value = '';
    document.getElementById('f').value = '';
    clearOutputs();
  }

  document.getElementById('calcBtn').addEventListener('click', calculate);
  document.getElementById('clearBtn').addEventListener('click', clearAll);
</script>

</body>
</html>
